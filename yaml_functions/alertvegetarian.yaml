metadata:
  name: alertvegetarian
  labels:
    nuclio.io/project-name: 8226f05d-5d61-44ba-bbea-899e4f1c3d6f
spec:
  handler: handler
  runtime: nodejs
  env:
    - name: API_KEY
      value: {YOUR_API_KEY}
  resources: {}
  image: "nuclio/processor-alertvegetarian:latest"
  minReplicas: 1
  maxReplicas: 1
  triggers:
    myMqttTrigger:
      class: ""
      kind: mqtt
      url: "guest:guest@{YOUR_IP}:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/alertVeg
  version: 1
  build:
    functionSourceCode: dmFyIHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0JykKCmNvbnN0IEFQSV9LRVkgPSBwcm9jZXNzLmVudi5BUElfS0VZCgpmdW5jdGlvbiBzZW5kTWFpbChpbmdyZWRpZW50LCBtZXNzYWdlRm9ybWF0dGVkKSB7CiAgICByZXF1ZXN0KHsKICAgICAgICB1cmw6ICcgaHR0cHM6Ly9tYWtlci5pZnR0dC5jb20vdHJpZ2dlci9hbGVydFZlZy93aXRoL2tleS8nK0FQSV9LRVksCiAgICAgICAgcXM6IHsKICAgICAgICAgICAgInZhbHVlMSI6IGluZ3JlZGllbnQsCiAgICAgICAgICAgICJ2YWx1ZTIiOiBtZXNzYWdlRm9ybWF0dGVkLAoKICAgICAgICB9LAogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJwogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChlcnJvciwgcmVzcG9uc2UsIGJvZHkpIHsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlLnN0YXR1c0NvZGUsIGJvZHkpOwogICAgICAgIH0KICAgIH0pOwp9CgpmdW5jdGlvbiBiaW4yc3RyaW5nKGFycmF5KSB7CiAgICB2YXIgcmVzdWx0ID0gIiI7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgcmVzdWx0ICs9IChTdHJpbmcuZnJvbUNoYXJDb2RlKGFycmF5W2ldKSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0Owp9CgpmdW5jdGlvbiBzcGxpdF9yZWNpcGVzKG1lc3NhZ2UpIHsKICAgIGNvbnN0IHJlY2lwZXMgPSBtZXNzYWdlLnNwbGl0KCdcbicpLm1hcCh4ID0+IHgudHJpbSgpKTsKICAgIHJldHVybiByZWNpcGVzOwp9CgpmdW5jdGlvbiBmb3JtYXRfbWVzc2FnZShyZWNpcGVzKSB7CiAgICBsZXQgbWVzc2FnZUZvcm1hdHRlZCA9ICcnCiAgICBmb3IgKGkgPSAwOyBpIDwgcmVjaXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgIG1lc3NhZ2VGb3JtYXR0ZWQgPSBtZXNzYWdlRm9ybWF0dGVkICsgcmVjaXBlc1tpXSArICI8YnI+IgogICAgfQogICAgcmV0dXJuIG1lc3NhZ2VGb3JtYXR0ZWQ7Cn0KCmV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uIChjb250ZXh0LCBldmVudCkgewogICAgdmFyIF9ldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTsKICAgIHZhciBfZGF0YSA9IGJpbjJzdHJpbmcoX2V2ZW50LmJvZHkuZGF0YSk7CiAgICBjb250ZXh0LmNhbGxiYWNrKCJmZWVkYmFjayAiICsgX2RhdGEpOwogICAgY29uc3QgbWVzc2FnZVdpdGhJbmdyZWRpZW50ID0gX2RhdGEuc3BsaXQoJywnKS5tYXAoeCA9PiB4LnRyaW0oKSk7CiAgICBpZiAobWVzc2FnZVdpdGhJbmdyZWRpZW50WzFdICE9PSAnJykgewogICAgICAgIGNvbnNvbGUubG9nKCJTZW5kaW5nIGFuIGVtYWlsIikKICAgICAgICBjb25zdCByZWNpcGVzID0gc3BsaXRfcmVjaXBlcyhtZXNzYWdlV2l0aEluZ3JlZGllbnRbMV0pCiAgICAgICAgY29uc3QgbWVzc2FnZUZvcm1hdHRlZCA9IGZvcm1hdF9tZXNzYWdlKHJlY2lwZXMpCiAgICAgICAgc2VuZE1haWwobWVzc2FnZVdpdGhJbmdyZWRpZW50WzBdLCBtZXNzYWdlRm9ybWF0dGVkKTsKICAgIH0KCn07
    commands:
      - 'npm install request'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
