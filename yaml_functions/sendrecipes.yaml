metadata:
  name: sendrecipes
  labels:
    nuclio.io/project-name: 32b88319-29ce-48ff-99a4-1df5a3edcf52
spec:
  handler: handler
  runtime: nodejs
  env:
    - name: IP
      value: {YOUR_IP}
    - name: API_KEY
      value: {YOUR_API_KEY}
  resources: {}
  image: "nuclio/processor-sendrecipes:latest"
  minReplicas: 1
  maxReplicas: 1
  version: 1
  build:
    functionSourceCode: Y29uc3QgbXF0dCA9IHJlcXVpcmUoJ21xdHQnKQpjb25zdCBodHRwcyA9IHJlcXVpcmUoJ2h0dHBzJyk7Cgpjb25zdCBJUCA9IHByb2Nlc3MuZW52LklQOwpjb25zdCBBUElfS0VZID0gcHJvY2Vzcy5lbnYuQVBJX0tFWQoKY29uc3QgUVVFVUVfUkVDSVBFUyA9ICdpb3QvcmVjaXBlcyc7CmNvbnN0IFFVRVVFX0FMRVJUX1ZFRyA9ICdpb3QvYWxlcnRWZWcnCgpsZXQgaWRSZWNpcGVzID0gW107CmxldCBtZXNzYWdlID0gJyc7CmxldCBtZXNzYWdlVmVnID0gJyc7CgpsZXQgYnVpbGRSZXF1ZXN0ID0gZnVuY3Rpb24gKHVybCwgZGF0YSkgewogICAgY29uc3QgcGFyYW1zID0gdHlwZW9mIGRhdGEgPT0gJ3N0cmluZycgPyBkYXRhIDogT2JqZWN0LmtleXMoZGF0YSkubWFwKAogICAgICAgIHggPT4gYCR7ZW5jb2RlVVJJQ29tcG9uZW50KHgpfT0ke2VuY29kZVVSSUNvbXBvbmVudChkYXRhW3hdKX1gCiAgICApLmpvaW4oJyYnKTsKICAgIHJldHVybiBgJHt1cmx9PyR7cGFyYW1zfWA7Cn0KCmxldCBzZW5kUmVxdWVzdCA9IGFzeW5jIGZ1bmN0aW9uIChyZXFVcmwsIHBhcmFtZXRlcnMpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgaHR0cHMuZ2V0KGJ1aWxkUmVxdWVzdChyZXFVcmwsIHBhcmFtZXRlcnMpLCBmdW5jdGlvbiAocmVzb3VyY2UpIHsKICAgICAgICAgICAgYm9keSA9ICIiCiAgICAgICAgICAgIHJlc291cmNlLnNldEVuY29kaW5nKCd1dGY4Jyk7CgogICAgICAgICAgICByZXNvdXJjZS5vbignZW5kJywgKCkgPT4gewogICAgICAgICAgICAgICAgcmVzb2x2ZShib2R5KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXNvdXJjZS5vbignZGF0YScsIChkYXRhKSA9PiB7CiAgICAgICAgICAgICAgICBib2R5ICs9IGRhdGE7CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9KS5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIHJlamVjdChlcnIubWVzc2FnZSk7CiAgICAgICAgfSkKICAgIH0pCn0KCmFzeW5jIGZ1bmN0aW9uIGdldFJlY2lwZXNCeUluZ3JlZGllbnQoaW5ncmVkaWVudCkgewogICAgbGV0IHBhcmFtZXRlcnMgPSB7CiAgICAgICAgYXBpS2V5OiBBUElfS0VZLAogICAgICAgIGluZ3JlZGllbnRzOiBpbmdyZWRpZW50LAogICAgICAgIG51bWJlcjogNQogICAgfTsKCiAgICBsZXQgcmVxVXJsID0gImh0dHBzOi8vYXBpLnNwb29uYWN1bGFyLmNvbS9yZWNpcGVzL2ZpbmRCeUluZ3JlZGllbnRzIjsKICAgIGxldCByZXEgPSBhd2FpdCBzZW5kUmVxdWVzdChyZXFVcmwsIHBhcmFtZXRlcnMpOwogICAgbGV0IGpSZXNwb25zZSA9IEpTT04ucGFyc2UocmVxKQogICAgbGV0IGxlbmd0aCA9IGpSZXNwb25zZS5sZW5ndGgKCiAgICBzZXRJZFJlY2lwZXMobGVuZ3RoLCBqUmVzcG9uc2UpOwogICAgYnVpbGRNZXNzYWdlQW5kU2VuZChpbmdyZWRpZW50KQp9Cgphc3luYyBmdW5jdGlvbiBzZXRJZFJlY2lwZXMobGVuZ3RoLCBqUmVzcG9uc2UpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgaWQgPSBqUmVzcG9uc2VbaV0uaWQ7CiAgICAgICAgaWRSZWNpcGVzLnB1c2goaWQpOwogICAgfQp9CgpsZXQgZ2V0UmVjaXBlSW5mb3JtYXRpb24gPSBhc3luYyBmdW5jdGlvbiAoaWRSZWNpcGUpIHsKICAgIGxldCBwYXJhbWV0ZXJzUmVxdWVzdCA9IHsKICAgICAgICBhcGlLZXk6IEFQSV9LRVkKICAgIH07CgogICAgbGV0IHJlcVVybCA9ICJodHRwczovL2FwaS5zcG9vbmFjdWxhci5jb20vcmVjaXBlcy8iICsgaWRSZWNpcGUgKyAiL2luZm9ybWF0aW9uIjsKICAgIGxldCByZXEgPSBhd2FpdCBzZW5kUmVxdWVzdChyZXFVcmwsIHBhcmFtZXRlcnNSZXF1ZXN0KTsKICAgIHJldHVybiBKU09OLnBhcnNlKHJlcSk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGJ1aWxkTWVzc2FnZUFuZFNlbmQoaW5ncmVkaWVudCkgewogICAgaWYgKGlkUmVjaXBlcy5sZW5ndGggPT09IDApIHsKICAgICAgICBtZXNzYWdlID0gIk5vIHJlY2lwZXMgZm91bmRcbiIKICAgICAgICBzZW5kX3RvX3R3b190b3BpY19tcXR0KFFVRVVFX1JFQ0lQRVMsIFFVRVVFX0FMRVJUX1ZFRywgbWVzc2FnZSwgJycpOwogICAgICAgIG1lc3NhZ2UgPSAnJwogICAgfSBlbHNlIHsKICAgICAgICBsZXQgY291bnQgPSAxOwogICAgICAgIGxldCBjb3VudFZlZyA9IDE7CiAgICAgICAgbWVzc2FnZSA9ICJSZWNpcGVzIHdpdGggIiArIGluZ3JlZGllbnQudG9Mb3dlckNhc2UoKSArICI6XG4iOwoKICAgICAgICBmb3IgKGxldCBpZCBvZiBpZFJlY2lwZXMpIHsKICAgICAgICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZ2V0UmVjaXBlSW5mb3JtYXRpb24oaWQpCiAgICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlICsgY291bnQgKyAiKSAiICsgcmVzcG9uc2UudGl0bGUgKyAiIC0gIiArIHJlc3BvbnNlLnNvdXJjZVVybCArICJcbiIKCiAgICAgICAgICAgIGlmIChyZXNwb25zZS52ZWdldGFyaWFuID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlVmVnID0gbWVzc2FnZVZlZyArIGNvdW50VmVnICsgIikgIiArIHJlc3BvbnNlLnRpdGxlICsgIiAtICIgKyByZXNwb25zZS5zb3VyY2VVcmwgKyAiXG4iCiAgICAgICAgICAgICAgICBjb3VudFZlZyA9IGNvdW50VmVnICsgMQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb3VudCA9IGNvdW50ICsgMQogICAgICAgIH0KCiAgICAgICAgc2VuZF90b190d29fdG9waWNfbXF0dChRVUVVRV9SRUNJUEVTLCBRVUVVRV9BTEVSVF9WRUcsIG1lc3NhZ2UsIGluZ3JlZGllbnQgKyAiLCIgKyBtZXNzYWdlVmVnKTsKICAgICAgICBjb3VudCA9IDAKICAgICAgICBjb3VudFZlZyA9IDAKICAgICAgICBtZXNzYWdlID0gJycKICAgICAgICBtZXNzYWdlVmVnID0gJycKICAgICAgICBpZFJlY2lwZXMgPSBbXTsKICAgIH0KfQoKYXN5bmMgZnVuY3Rpb24gc2VuZF90b190d29fdG9waWNfbXF0dCh0b3BpYzEsIHRvcGljMiwgZGF0YTEsIGRhdGEyKSB7CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICBob3N0OiBgbXF0dDovL2d1ZXN0Omd1ZXN0QCR7SVB9YCwKICAgICAgICBjbGllbnRJZDogJ21xdHRqc18nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc3Vic3RyKDIsIDgpLAogICAgICAgIHVzZXJuYW1lOiAnZ3Vlc3QnLAogICAgICAgIHBhc3N3b3JkOiAnZ3Vlc3QnLAogICAgfTsKICAgIHZhciBjbGllbnQgPSBtcXR0LmNvbm5lY3QoYG1xdHQ6Ly9ndWVzdDpndWVzdEAke0lQfToxODgzYCwgb3B0aW9ucyk7CiAgICBjbGllbnQub24oJ2Nvbm5lY3QnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgY2xpZW50LnB1Ymxpc2godG9waWMxLCBkYXRhMSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjbGllbnQucHVibGlzaCh0b3BpYzIsIGRhdGEyLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjbGllbnQuZW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfSk7Cn0KCmV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uIChjb250ZXh0LCBldmVudCkgewogICAgbGV0IF9ldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTsKICAgIGNvbnN0IGluZ3JlZGllbnQgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLl9ldmVudC5ib2R5LmRhdGEpOwoKICAgIGlmIChpbmdyZWRpZW50Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNvbnRleHQuY2FsbGJhY2soYEVycm9yLCB5b3UgaGF2ZSB0byBpbnNlcnQgb25lIGluZ3JlZGllbnRgKQogICAgfSBlbHNlIHsKICAgICAgICBnZXRSZWNpcGVzQnlJbmdyZWRpZW50KGluZ3JlZGllbnQpCiAgICAgICAgY29udGV4dC5jYWxsYmFjayhgSW5ncmVkaWVudCBsb2FkZWQ6ICR7aW5ncmVkaWVudH1gKQogICAgfQoKfTs=
    commands:
      - 'npm install mqtt'
      - 'npm install https'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
